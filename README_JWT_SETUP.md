# HLS JWT Token Authentication Setup

This setup provides secure token-based authentication for HLS video streams using JWT tokens generated by Laravel and validated by nginx with OpenResty Lua.

## Components

1. **Laravel JWT Token Generation** (`HLSTokenService.php`)
2. **nginx OpenResty Configuration** (`nginx.edge.http.conf.template`)
3. **Lua Token Validation** (`token_auth.lua`)

## Setup Instructions

### 1. Laravel Setup

#### Install JWT Library
```bash
composer require firebase/jwt
```

#### Environment Configuration
Add to your `.env` file:
```
VIDEO_JWT_SECRET=your-very-secure-secret-key-here
```

#### Config File
Create `config/video.php`:
```php
<?php

return [
    'video_jwt_secret' => env('VIDEO_JWT_SECRET', 'default-secret-key'),
];
```

#### Usage in Laravel Controller
```php
<?php

namespace App\Http\Controllers;

use App\Services\HLSTokenService;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;

class VideoController extends Controller
{
    protected $hlsTokenService;

    public function __construct(HLSTokenService $hlsTokenService)
    {
        $this->hlsTokenService = $hlsTokenService;
    }

    public function getVideoAccess(Request $request, string $videoId): JsonResponse
    {
        $user = auth()->user();
        
        // Generate JWT token for video access
        $token = $this->hlsTokenService->generateTokenWithValidation(
            $user->id,
            $videoId,
            $request,
            60 // 60 minutes expiration
        );

        if (!$token) {
            return response()->json(['error' => 'Access denied'], 403);
        }

        // Generate playlist URL
        $playlistUrl = $this->hlsTokenService->generatePlaylistUrl(
            config('app.cdn_url'), // Your CDN/nginx server URL
            $videoId,
            $token
        );

        return response()->json([
            'token' => $token,
            'playlist_url' => $playlistUrl,
            'expires_in' => 3600 // seconds
        ]);
    }
}
```

### 2. Docker Setup

#### Docker Compose
Update your `docker-compose.yml` to include the JWT secret:
```yaml
version: '3.8'
services:
  nginx:
    build: .
    ports:
      - "80:80"
    environment:
      - VIDEO_JWT_SECRET=your-very-secure-secret-key-here
      - ORYX_SERVER=your-streaming-server:port
      - SRS_M3U8_EXPIRE=30
      - SRS_TS_EXPIRE=300
    volumes:
      - ./token_auth.lua:/usr/local/openresty/lualib/token_auth.lua
      - ./nginx.edge.http.conf.template:/etc/nginx/conf.d/default.conf.template
      - ./cache:/data/nginx-cache
      - ./logs:/var/log/nginx
```

#### Dockerfile
Ensure your Dockerfile includes OpenResty with JWT support:
```dockerfile
FROM openresty/openresty:alpine

# Install required Lua modules
RUN /usr/local/openresty/luajit/bin/luarocks install lua-resty-jwt

# Copy configuration files
COPY nginx.edge.http.conf.template /etc/nginx/conf.d/default.conf.template
COPY token_auth.lua /usr/local/openresty/lualib/token_auth.lua

# Create cache directories
RUN mkdir -p /data/nginx-cache/tmp

# Start nginx with environment variable substitution
CMD ["/bin/sh", "-c", "envsubst '${ORYX_SERVER} ${SRS_M3U8_EXPIRE} ${SRS_TS_EXPIRE}' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && /usr/local/openresty/bin/openresty -g 'daemon off;'"]
```

### 3. Client-Side Usage

#### JavaScript/HTML5 Video Player
```javascript
// Get video access token from your Laravel API
async function getVideoAccess(videoId) {
    const response = await fetch(`/api/video/${videoId}/access`, {
        headers: {
            'Authorization': `Bearer ${userAuthToken}`,
            'Accept': 'application/json'
        }
    });
    
    const data = await response.json();
    return data;
}

// Play video with HLS.js
async function playVideo(videoId) {
    try {
        const videoAccess = await getVideoAccess(videoId);
        
        if (Hls.isSupported()) {
            const video = document.getElementById('video');
            const hls = new Hls({
                xhrSetup: function(xhr, url) {
                    // Token is already included in the playlist URL
                }
            });
            
            hls.loadSource(videoAccess.playlist_url);
            hls.attachMedia(video);
        }
    } catch (error) {
        console.error('Error playing video:', error);
    }
}
```

### 4. Security Features

- **JWT Token Validation**: Tokens are cryptographically signed and validated
- **Expiration Check**: Tokens automatically expire after specified time
- **Video ID Binding**: Each token is bound to a specific video
- **IP Address Binding**: Tokens are optionally bound to client IP
- **User Agent Validation**: Basic user agent validation (logged as warning)
- **Browser-Only Access**: Non-browser requests are blocked
- **Cache Security**: Cache keys include video ID for isolation

### 5. Testing

#### Generate Test Token
```bash
# In your Laravel app
php artisan tinker

$service = new App\Services\HLSTokenService();
$request = request();
$token = $service->generateToken(1, 'video-uuid-123', $request);
echo $token;
```

#### Test URL
```
http://your-nginx-server/video-uuid-123/index.m3u8?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
```

### 6. Monitoring and Logs

Check nginx logs for token validation:
```bash
tail -f logs/access.log
tail -f logs/error.log
```

The Lua script logs validation events, so you can monitor:
- Token validation success/failure
- Expired tokens
- Invalid video access attempts
- IP/User-Agent mismatches

## Security Considerations

1. **Secret Key**: Use a strong, unique secret key and keep it secure
2. **Token Expiration**: Set appropriate expiration times (recommend 1-24 hours)
3. **HTTPS**: Always use HTTPS in production
4. **IP Binding**: Consider if IP binding works with your user base (mobile users change IPs)
5. **Rate Limiting**: Implement rate limiting on token generation endpoints
6. **Monitoring**: Monitor for suspicious token usage patterns